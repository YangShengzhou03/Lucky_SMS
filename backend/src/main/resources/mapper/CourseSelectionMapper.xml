<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yangshengzhou.lucky_sms.mapper.CourseSelectionMapper">

    <!-- 插入选课记录 -->
    <insert id="insert" parameterType="com.yangshengzhou.lucky_sms.entity.CourseSelection"
            useGeneratedKeys="true" keyProperty="selectionId">
        INSERT INTO course_selections (student_id, assignment_id, status)
        VALUES (#{studentId}, #{assignmentId}, #{status})
    </insert>

    <!-- 根据学生ID和授课ID查询选课记录 -->
    <select id="findByStudentAndAssignment" resultType="com.yangshengzhou.lucky_sms.entity.CourseSelection">
        SELECT * FROM course_selections 
        WHERE student_id = #{studentId} AND assignment_id = #{assignmentId}
    </select>

    <!-- 更新选课状态 -->
    <update id="updateStatus">
        UPDATE course_selections 
        SET status = #{status}, updated_at = NOW()
        WHERE selection_id = #{selectionId}
    </update>

    <!-- 根据授课ID获取最大选课人数 -->
    <select id="getMaxStudentsByAssignmentId" resultType="java.lang.Integer">
        SELECT max_students FROM teaching_assignments 
        WHERE assignment_id = #{assignmentId}
    </select>

    <!-- 根据授课ID获取当前选课人数 -->
    <select id="getCurrentStudentsByAssignmentId" resultType="java.lang.Integer">
        SELECT current_students FROM teaching_assignments 
        WHERE assignment_id = #{assignmentId}
    </select>

    <!-- 增加当前选课人数 -->
    <update id="incrementCurrentStudents">
        UPDATE teaching_assignments 
        SET current_students = current_students + 1, updated_at = NOW()
        WHERE assignment_id = #{assignmentId} AND current_students < max_students
    </update>

    <!-- 减少当前选课人数 -->
    <update id="decrementCurrentStudents">
        UPDATE teaching_assignments 
        SET current_students = current_students - 1, updated_at = NOW()
        WHERE assignment_id = #{assignmentId} AND current_students > 0
    </update>

</mapper>