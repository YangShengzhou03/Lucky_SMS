<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yangshengzhou.lucky_sms.mapper.student.StudentMapper">
    <!-- 1. 定义显式映射规则：column 对应 SQL 列名，property 对应 StudentVO 属性名 -->
    <resultMap id="StudentVOMap" type="com.yangshengzhou.lucky_sms.vo.student.StudentVO">
        <result column="username" property="username"/>
        <result column="student_no" property="student_no"/>
        <result column="gpa" property="gpa"/>
        <result column="class_rank" property="class_rank"/>
        <result column="classSize" property="classSize"/>
        <result column="class_name" property="class_name"/>
        <result column="course_count" property="course_count"/>
    </resultMap>

    <!-- 2. 使用 resultMap 替换 resultType -->
    <select id="selectStudentById" parameterType="Integer" resultMap="StudentVOMap">
        SELECT
            u.username,
            s.student_no AS student_no,
            s.gpa,
            s.class_rank,
            (SELECT COUNT(*) FROM students WHERE class_id = s.class_id) AS classSize,
            ci.class_name AS class_name,
            (
                SELECT COUNT(*)
                FROM course_selections cs
                         INNER JOIN teaching_assignments ta ON cs.assignment_id = ta.assignment_id
                WHERE cs.student_id = s.student_id AND cs.`STATUS` = 'SELECTED'
            ) AS course_count
        FROM
            users u
                INNER JOIN students s ON u.user_id = s.user_id
                LEFT JOIN class_info ci ON s.class_id = ci.class_id
        WHERE
            u.user_id = #{userId}
    </select>

    <!-- 1. 定义 Todos 的显式映射规则 -->
    <resultMap id="TodosMap" type="com.yangshengzhou.lucky_sms.pojo.Todos">
        <result column="id" property="id"/>
        <result column="text" property="text"/>
        <result column="completed" property="completed"/>
        <result column="due_date" property="dueDate"/>
        <result column="important" property="important"/>
        <result column="category" property="category"/>
    </resultMap>

    <!-- 2. 修改 select 标签 -->
    <select id="selectTodosList" parameterType="Integer" resultMap="TodosMap">
        SELECT
        id,
        text,
        completed,
        due_date,  <!-- 数据库 Date 类型列，通过 TodosMap 映射到属性 -->
        important,
        category
        FROM todos
        WHERE user_id = #{userId}
    </select>

    <!-- 选择出公告 -->
    <select id="selectAnnouncementList" resultType="com.yangshengzhou.lucky_sms.pojo.Announcement">
        SELECT
            id,
            title,
            content,
            date,
            department,
            type,
            priority
        FROM announcements
    </select>

    <!-- 1. 定义 Todos 的显式映射规则 -->
    <resultMap id="BasicInfoMap" type="com.yangshengzhou.lucky_sms.pojo.BasicInfo">
        <result column="status_name" property="status"/>
        <result column="gpa" property="gpa"/>
        <result column="total_credits" property="completedCredits"/>
        <result column="enrollment_date" property="enrollmentDate"/>
        <result column="expectedGraduationDate" property="expectedGraduationDate"/>
    </resultMap>

    <!-- 选择出BasicInfo数据 -->
    <select id="selectBasicInfoById" parameterType="Integer" resultMap="BasicInfoMap">
        SELECT
            status_name,
            gpa,
            total_credits,
            enrollment_date,
            DATE_ADD(enrollment_date, INTERVAL students.education_years YEAR) AS expectedGraduationDate
        FROM students
                 INNER JOIN student_statuses ON students.status_id = student_statuses.status_id
        WHERE user_id = #{userId}
    </select>

<!--    &lt;!&ndash; 选择出AcademicHistoryList数据 &ndash;&gt;-->
<!--    <select id="selectAcademicHistoryList" parameterType="Integer" resultType="com.yangshengzhou.lucky_sms.pojo.AcademicHistory">-->
<!--        SELECT-->

<!--    </select>-->

</mapper>